@page "/symbols"
@using OperationResult = TheOmenDen.Shared.Enumerations.OperationResult
<Tabs RenderMode="TabsRenderMode.LazyReload"
      SelectedTab="@_selectedTab"
      SelectedTabChanged="@OnSelectedTabChangedAsync"
      FullWidth>
    <Items>
        <Tab Name="manaCosts"
             Border="Border.Is1.Rounded.Light.OnAll"
             TextWeight="TextWeight.Bold">
            Mana Costs
        </Tab>
        <Tab Name="manaRepresentatives"
             Border="Border.Is1.Rounded.Light.OnAll"
             TextWeight="TextWeight.Bold">
            Mana Representations
        </Tab>
        <Tab Name="transposables"
             Border="Border.Is1.Rounded.Light.OnAll"
             TextWeight="TextWeight.Bold">
            Transposables
        </Tab>
        <Tab Name="funny"
             Border="Border.Is1.Rounded.Light.OnAll"
             TextWeight="TextWeight.Bold">
            Funny
        </Tab>
        <Tab Name="other"
             Border="Border.Is1.Rounded.Light.OnAll"
             TextWeight="TextWeight.Bold">
            Other
        </Tab>
    </Items>
    <Content>
        <TabPanel Name="manaCosts"
                  Height="Height.Is100"
                  ElementId="#manacostspanel-animate">
            <CardDeck>
                <Repeater TItem="SymbologyDatum" Items="@_manaCostSymbols" Context="manaSymbolContext">
                    <Animate Anchor="#manacostspanel-animate"
                             Auto
                             Animation="@Animations.SlideUp"
                              DelayMilliseconds="@(500 + (_funnySymbols.IndexOf(manaSymbolContext)* 50))">
                    <Card Shadow="Shadow.Default"
                          Margin="Margin.Is3.OnX.Is4.OnY"
                          Padding="Padding.Is2.OnX.Is3.OnY"
                          Border="Border.Is2.Secondary.OnAll.Rounded">
                        <CardBody>
                            <CardTitle TextColor="TextColor.Dark" Size="3">@manaSymbolContext.Symbol</CardTitle>
                            <CardSubtitle TextColor="TextColor.Muted"
                                          TextTransform="TextTransform.Capitalize">@manaSymbolContext.English</CardSubtitle>
                            <CardImage data-src="@manaSymbolContext.SvgUri"
                                       data-sizes="auto"
                                       Style="height:64px;width:64px;"
                                       Alt="@manaSymbolContext.English"
                                       Class="lazyload" />
                        </CardBody>
                    </Card>
                    </Animate>
                </Repeater>
            </CardDeck>
        </TabPanel>
        <TabPanel Name="manaRepresentatives"
                  Height="Height.Is100"
                  ElementId="#manarepresentables-panel">
            <CardDeck>
                <Repeater TItem="SymbologyDatum" Items="@_manaSymbols" Context="manaRepresentativeContext">
                    <Animate Anchor="#manarepresentables-animate"
                             Auto
                             Animation="@Animations.SlideUp"
                              DelayMilliseconds="@(500 + (_funnySymbols.IndexOf(manaRepresentativeContext)* 50))">
                    <Card Shadow="Shadow.Default"
                          Margin="Margin.Is3.OnX.Is4.OnY"
                          Padding="Padding.Is2.OnX.Is3.OnY"
                          Border="Border.Is2.Secondary.OnAll.Rounded">
                        <CardBody>
                            <CardTitle TextColor="TextColor.Dark" Size="3">@manaRepresentativeContext.Symbol</CardTitle>
                            <CardSubtitle TextColor="TextColor.Muted"
                                          TextTransform="TextTransform.Capitalize">@manaRepresentativeContext.English</CardSubtitle>
                            <CardImage data-src="@manaRepresentativeContext.SvgUri"
                                       data-sizes="auto"
                                       Style="height:64px;width:64px;"
                                       Alt="@manaRepresentativeContext.English"
                                       Class="lazyload" />
                        </CardBody>
                    </Card>
                    </Animate>
                </Repeater>
            </CardDeck>
        </TabPanel>
        <TabPanel Name="transposables"
                  Height="Height.Is100"
                  ElementId="transposablespanel-animate">
            <CardDeck>
                <Repeater TItem="SymbologyDatum" Items="@_transposableSymbols" Context="transposableContext">
                    <Animate Anchor="#funnypanel-animate"
                             Auto
                             Animation="@Animations.SlideUp"
                             DelayMilliseconds="@(500 + (_funnySymbols.IndexOf(transposableContext)* 50))">
                    <Card Shadow="Shadow.Default"
                          Margin="Margin.Is3.OnX.Is4.OnY"
                          Padding="Padding.Is2.OnX.Is3.OnY"
                          Border="Border.Is2.Secondary.OnAll.Rounded">
                        <CardBody>
                            <CardTitle TextColor="TextColor.Dark" Size="3">@transposableContext.Symbol</CardTitle>
                            <CardSubtitle TextColor="TextColor.Muted"
                                          TextTransform="TextTransform.Capitalize">@transposableContext.English</CardSubtitle>
                            <CardImage data-src="@transposableContext.SvgUri"
                                       data-sizes="auto"
                                       Style="height:64px;width:64px;"
                                       Alt="@transposableContext.English"
                                       Class="lazyload" />
                        </CardBody>
                    </Card>
                    </Animate>
                </Repeater>
            </CardDeck>
        </TabPanel>
        <TabPanel Name="funny"
                  Height="Height.Is100"
                  ElementId="#funnypanel-animate">
            <CardDeck>
                <Repeater TItem="SymbologyDatum" Items="@_funnySymbols" Context="funnyContext">
                    <Animate Anchor="#funnypanel-animate"
                              Auto
                              Animation="@Animations.SlideLeft"
                              DelayMilliseconds="@(500 + (_funnySymbols.IndexOf(funnyContext)* 50))">
                         <Card Shadow="Shadow.Default"
                               Margin="Margin.Is3.OnX.Is4.OnY"
                               Padding="Padding.Is2.OnX.Is3.OnY"
                               Border="Border.Is2.Secondary.OnAll.Rounded">
                             <CardBody>
                                 <CardTitle TextColor="TextColor.Dark" Size="3">@funnyContext.Symbol</CardTitle>
                                 <CardSubtitle TextColor="TextColor.Muted"
                                               TextTransform="TextTransform.Capitalize">@funnyContext.English</CardSubtitle>
                                 <CardImage data-src="@funnyContext.SvgUri"
                                            data-sizes="auto"
                                            Style="height:64px;width:64px;"
                                            Alt="@funnyContext.English"
                                            Class="lazyload" />
                             </CardBody>
                         </Card>
                     </Animate>
                 </Repeater>
             </CardDeck>
         </TabPanel>
         <TabPanel Name="other"
                   Height="Height.Is100"
                   ElementId="#other-animate">
             <CardDeck>
                 <Repeater TItem="SymbologyDatum" Items="@_otherSymbols" Context="miscContext">
                     <Animate Anchor="#other-animate"
                              Auto
                              Animation="@Animations.SlideLeft"
                              DelayMilliseconds="@(500 + (_funnySymbols.IndexOf(miscContext)* 50))">
                     <Card Shadow="Shadow.Default"
                           Margin="Margin.Is3.OnX.Is4.OnY"
                           Padding="Padding.Is2.OnX.Is3.OnY"
                           Border="Border.Is2.Secondary.OnAll.Rounded">
                         <CardBody>
                             <CardTitle TextColor="TextColor.Dark" Size="3">@miscContext.Symbol</CardTitle>
                             <CardSubtitle TextColor="TextColor.Muted"
                                           TextTransform="TextTransform.Capitalize">@miscContext.English</CardSubtitle>
                             <CardImage data-src="@miscContext.SvgUri"
                                        data-sizes="auto"
                                        Style="height: 64px; width: 64px;"
                                        Alt="@miscContext.English"
                                        Class="lazyload"/>
                         </CardBody>
                     </Card>
                     </Animate>
                 </Repeater>
             </CardDeck>
         </TabPanel>
     </Content>
 </Tabs>

 @code {

    [Inject] private ScryfallSymbologyService _symbologyService { get; init; }
    [Inject] private IMessageService MessageService { get; init; }

     [Inject]
     private ILoadingIndicatorService LoadingIndicatorService { get; init; }
    private List<SymbologyDatum> _symbols = new(200);

    private readonly List<SymbologyDatum> _funnySymbols = new(50);

    private readonly List<SymbologyDatum> _manaSymbols = new(20);

    private readonly List<SymbologyDatum> _manaCostSymbols = new(40);

    private readonly List<SymbologyDatum> _transposableSymbols = new(40);

    private readonly List<SymbologyDatum> _otherSymbols = new(40);

    private string _selectedTab = "manaCosts";

    protected override async Task OnInitializedAsync()
    {
        await LoadingIndicatorService.Show();
        if (!StringBuilderPoolFactory<GameSymbols>.Exists(nameof(GameSymbols)))
        {
            StringBuilderPoolFactory<GameSymbols>.Create(nameof(GameSymbols));
        }

        var symbolEndPointResponse = await _symbologyService.GetAllSymbolsFromScryfall().ConfigureAwait(false);

        if (symbolEndPointResponse.Outcome.OperationResult == OperationResult.Failure)
        {
            await OnApiFailureAsync().ConfigureAwait(false);
            return;
        }

        PopulateSymbolInformationAsync(symbolEndPointResponse);
        await LoadingIndicatorService.Hide();
    }

    private async Task OnApiFailureAsync()
    {
        var builder = StringBuilderPoolFactory<GameSymbols>.Get(nameof(GameSymbols));
        builder.Append("<a href='https://www.scryfall.com' class='text-link'>Scryfall Api</a> is down");
        builder.Append("<br /><strong><em>Please refresh the page</em></strong>");
        builder.Append(
        "<br /><hr>If the error still persists, create an issue on our <a href='https://github.com/theomenden/MTGView.Blazor.Server/issues' class='text-link'>GitHub!</a>");
        await MessageService.Error(new MarkupString(builder.ToString()), "Scryfall API could not be reached");
    }

    private void PopulateSymbolInformationAsync(ApiResponse<IEnumerable<SymbologyDatum>> symbolEndPointResponse)
    {
        _symbols = symbolEndPointResponse.Data.Select(symbolInformation => symbolInformation).ToList();

        _funnySymbols.AddRange(_symbols.Where(symbol => symbol.IsFunny));

        _manaCostSymbols.AddRange(_symbols.Where(symbol => symbol.CanBeInManaCost));

        _manaSymbols.AddRange(_symbols.Where(symbol => symbol.IsManaRepresentative));

        _transposableSymbols.AddRange(_symbols.Where(symbol => symbol.IsTransposable));

        _otherSymbols.AddRange(_symbols.Where(symbol =>
            !symbol.IsFunny && !symbol.CanBeInManaCost && !symbol.IsManaRepresentative && !symbol.IsTransposable));
    }

    private Task OnSelectedTabChangedAsync(string name)
    {
        _selectedTab = name;

        return Task.CompletedTask;
    }
}